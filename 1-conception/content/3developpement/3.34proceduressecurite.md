+++
title = "3.34 Procédures-veille sécurité"
date = 2025-03-22T18:40:23+01:00
weight = 33400
+++

{{< table_of_contents >}}

## 3.34.1. - Projet Socle
Le projet Socle est paramétré pour fournir une liste des failles de sécurité associées à chaque dépendance Maven utilisée dans les sources.

**/!\ Il est préférable de réaliser l'analyse à la suite d'une montée de version des principales librairies et des principaux framework ! (et non avant)**

___
### 3.34.1.1 - Mettre à jour les dépendances Java
Les fichiers _pom.xml_, _2-code/front/pom.xml_ et _2-code/socle/pom.xml_ sont aménagés pour faciliter cette montée de version : en face de chaque propriété _<version.xxxx>_ est placé le lien direct vers le site _mvnrepository.com_ permettant de vérifier la dernière version disponible.

La montée de version consiste donc en :
* la modification de la version de chaque dépendance directe (depuis les fichiers _pom.xml_) pour utiliser la dernière version disponible ;
* la déconnexion de tout réseau nécessitant un proxy et leur désactivation (le téléchargement des dépendances sera plus rapide et celui de _flapdoodle_ ne supporte pas les proxy)
* la compilation **uniquement** (_-DskipTests -T 1C_) de l'ensemble du projet (au besoin, utiliser _Eclipse_ pour tout compiler après le premier échec et le téléchargement de la plus part des dépendances) ;
* la correction de toutes les nouveaux avertissements (notamment _Deprecated_)
* le build de l'ensemble du code ;
* la purge de tous les éléments du socle (logs, données de base de données et cache) avec l'outil ```. ./outils.sh``` depuis le répertoire _2-code/socle_ ;
* pour gagner du temps, recréer le fichier de cache du référentiel des SIRET (cf. [§3.2.11](/documentation/3developpement/3.2installationdeposte/#3211---initialiser-un-fichier-de-cache))
* le démarrage de tous les composants applicatifs avec la commande ```. ./demarrerTout.sh``` depuis le répertoire _2-code/socle_ ;
* la vérification du bon démarrage de tous les composants applicatifs ;
* l'exécution des tests depuis _UseBruno_ : suivre les étapes du chapitre [règles de test des requêtes HTTP](/documentation/3developpement/3.24reglesdetest/#3243---les-requêtes-http) ;
* le démarrage des démarches compilées avec la commande ```npm run http-start``` depuis le répertoire _2-code/front_ ;
* l'exécution de tests manuels depuis les démarches ;
* l'arrêt de tous les composants applicatifs avec la commande ```. ./arreterTout.sh``` depuis le répertoire _2-code/socle_ ;
* la suppression de la précédente version de _flapdoodle_ (_.embedmongo/windows/mongodb-windows-x86_64-xxx.zip_ et _embedmongo/Windows-B64--unknown---xxx_) ;
* la mise à jour, dans le fichier _4.2quoi.md_, des dates de l'actuelle et de la prochaine mise à jour des dépendances du _socle_ ;
* la vérification des licences associées aux dépendances (cf. [§3.34.5](/documentation/3developpement/3.34proceduressecurite/#3345---suivi-de-sécurité-avec-dependencytrack))
* le commit de la montée de version.

___
### 3.34.1.2 - Chiffrement / déchiffrement des mots de passe (ou clefs) dans les fichiers de configuration
Tout mot de passe ou clef de configuration doit être stocké(s) sous forme chiffrée. Pour cela il suffit :
* de démarrer (ou avoir déjà démarré) les services _service-gateway_ et _service-registry_ (nécessaires pour appeler les APIs exposées par _service-config_)
* de commenter, dans le fichier _application-specifique.properties_ du projet _service-config_, les clefs spring.security.user.xx
* de commenter, dans le _pom.xml_ du même projet, la dépendance à _spring-boot-starter-security_ dans le _pom.xml_ de _service-config_
* de démarrer le service service-config
* d'utiliser l'API _http://localhost:xxxx/encrypt_ depuis l'IDE HTTP (UseBruno) pour chiffrer une valeur fournie dans le corps de la requête
* de placer cette valeur chiffrée dans le fichier de properties souhaité en la préfixant par _{cipher}_

A savoir :
* Pour déchiffrer une valeur, une API _decrypt_ existe aussi.
* Pour créer le keystore, les étapes à suivre sont ([ici](https://cloud.spring.io/spring-cloud-config/reference/html/#_key_management)) :
  * se placer dans un répertoire et ouvrir une ligne de commande
  * exécuter la commande ```keytool -genkeypair -alias clefDeTest -keyalg RSA -dname "CN=ServiceConfig,OU=Moi,O=Perso,L=Amiens,S=France,C=FR" -keystore service-config.jks -storepass MotDePasseStore```
  * placer le fichier _service-config.jks_ n'importe où et utiliser la clef _cheminkeystore_ pour pointer sur le répertoire contenant le keystore (dans les sources, le keystore est présent dans le répertoire _src/test/resources_ du projet _service-config_ pour ne pas être embarqué dans le JAR exécutable)

___
## 3.34.2 - Projet Front

### 3.34.2.1 - Montée de version Angular 
La mise à jour d'Angular est régulière car une version sort régulièrement.
Elle est à réaliser de la manière suivante :
* avant la montée de version, vérifier que le projet _front_ fonctionne en 
  * exécutant un build complet ```npm run all-build-prod``` puis ```npm run all-postBuildProd-setOIDC```
  * exécutant les tests ```npm run e2e``` vs ```npm run xx-start``` avec xx chacune des démarches
* ouvrir le [site guidant chaque montée de version Angular](https://update.angular.io/)
* si une nouvelle version majeure est disponible
  * sélectionner la version source (actuelle et donc présente dans le _package.json_) et la dernière version GA proposée sur le site
  * suivre les instructions fournies par le site en complément des commandes ci-dessous (potentiellement avant ou après)
    * ne pas exécuter la commande ```ng update ...``` de la procédure d'Angular (prévu plus bas)
    * en cas de besoin, le paramètre _--allow-dirty_ de la commande _ng update_ permet une exécution de la mise à jour sans devoir tout commiter
* dans une ligne de commande DOS, mettre @angular/cli à jour avec la commande
```npm install --save-dev @angular/cli```
* pour réaliser la mise à jour, exécuter ```npm run update-angular```
* vérifier que toutes les versions modifiées sont identiques entre elles sinon les harmoniser à la main (sauf _@angular-builders*_)
* installer les dépendances avec la commande ```npm install``` (normalement inutile)
* vérifier que le projet _front_ fonctionne en 
  * exécutant un build complet ```npm run all-build-prod``` puis ```npm run all-postBuildProd-setOIDC```
  * exécutant les tests ```npm run e2e``` vs ```npm run xx-start``` avec xx chacune des démarches
* mettre à jour la page contenant la backlog et programmer la prochaine mise à jour pour le prochain trimestre

## 3.34.2.2 - Montée de version Angular compliquée
En cas de problème sur une montée de version, il est parfois nécessaire de recréer un projet de zéro pour avoir une référence et de traiter à la main les différences entre le projet de référence et le vrai projet.

Pour cela, il faut 
* créer un nouveau workspace Angular avec une librairie et une application avec les commandes suivantes ([source](https://angular.dev/reference/configs/file-structure#multiple-projects)) :
  * se placer dans le répertoire _/2-code_ et y ouvrir une ligne de commande _DOS_ (pas _gitBash_ car des questions sont posées et _gitBash_ ne le supporte pas en 11/2022)
  * ```npm install --location=global @angular/cli@latest``` pour mettre à jour le CLI d'Angular (oui en _NPM_ même si le reste du projet est en _Yarn_)
  * supprimer le répertoire existant _/2-code/front-exemple_
  * ```ng new front-exemple --create-application false```  pour créer une nouvelle application avec la dernière version disponible
  * ```cd front-exemple``` pour entrer dans le répertoire de la nouvelle application
  * ```ng generate library framework --skip-package-json true --skip-install true``` pour créer une librairie
  * ```ng generate application bibliotheque --routing false --skip-tests true --style scss --ssr false``` pour créer une application
  * ```npm install angular-oauth2-oidc espression ngx-logger font-awesome font-awesome-animation @gouvfr/dsfr @angular/material @angular/cdk --save``` pour ajouter les dépendances actuelles du projet
    * en cas de problème avec la commande à cause d'une dépendance de la librairie DSFR, essayer d'ajouter le paramètre ```--legacy-peer-deps```
  * ```npm install @compodoc/compodoc @cypress/schematic cypress cypress-fail-fast cypress-html-validate html-validate ng-packagr npm-check-updates source-map-explorer @cypress/webpack-batteries-included-preprocessor @cypress/webpack-preprocessor @cypress/code-coverage http-server --save-dev``` pour ajouter les dépendances actuelles du projet
    * en cas de problème avec la commande à cause d'une dépendance de la librairie DSFR, essayer d'ajouter le paramètre ```--legacy-peer-deps```
  * désinstaller le client Angular global avec la commande ```npm remove --location=global @angular/cli```
* récupérer le contenu du projet actuel
  * supprimer le fichier _README.md_
  * dans le nouveau projet, supprimer les répertoires _projects\framework\public_, _projects\bibliotheque\public_, _projects\framework\src_ et _projects\bibliotheque\src_
  * récupérer les 4 mêmes répertoires du projet actuel
  * récupérer aussi :
    * _cypress.config.ts_
	* _projects\framework\cypress_
	* _projects\bibliotheque\cypress_
* éditer le fichier _angular.json_ pour
  * supprimer la balise _architect > test_ et _architect > extract-i18n_
  * récupérer la balise _architect > cypress-open_
  * dans les _assets_ du projet _biliotheque_, ajouter ```,{"glob": "**/*","input": "projects/framework/public","output": "/public/"},{"glob": "**/*","input": "@gouvfr/dsfr/dist/favicon","output": "/dsfr/"}```
  * dans les _styles_ du projet _biliotheque_, ajouter ```,"@gouvfr/dsfr/dist/dsfr/dsfr.min.css","@gouvfr/dsfr/dist/utility/utility.main.min.css","projects/framework/public/styles.scss"```
  * dans les _scripts_ du projet _biliotheque_, ajouter ```"@gouvfr/dsfr/dist/dsfr.module.min.js"```
* éditer le fichier _package.json_ pour 
  * récupérer la balise _author_
  * récupérer les scripts _install-1-cypress_, _install-2-cypress_, _bibliotheque-start_ et _e2e_
* tester ce projet 
  * en installant _Cypress_ avec les deux script d'installation
  * en démarrant la démarche avec la commande ```npm run bibliotheque-start```
  * en lançant _Cypress _ et exécutant les tests avec la commande ```npm run e2e```
* généraliser à tous les projets
  * importer le code de tous les projets
  * tester tous les projets avec les tests _Cypress_
  * relire les logs et vérifier les screenshots générés
* réaliser les tests spéciaux :
  * vérifier la bonne validation HTML des pages durant les tests E2E 
    * en retirant la configuration spécifique du projet en commentant la partie configuration du code ```require('cypress-html-validate/plugin').install(on, {...})``` dans le fichier cypress.config.ts
	* relançant les tests E2E sur le projet _bibliotheque_ qui devrait échouer
  * tester les _build-prod_
    * exécuter un ```npm run all-build-prod```
	* exécuter un ```npm run http-start```
	* exécuter tous les tests E2E
  * tester la génération de la documentation
    * recopier les fichiers _tsconfig.doc.json_ et le fichier _tsconfig.doctest.json_ présents dans les répertoires de projet depuis l'ancienne arborescence vers la nouvelle
	* exécuter ```npm run all-compodoc```
	* démarrer le serveur de documentation avec ```1-conception\startServer.cmd```
	* vérifier la présence et la qualité de la documentation depuis le site documentaire (lien dans le chapitre §3.1)
  * couverture de code avec les tests E2E
    * depuis la version Angular-18 (juillet 2024), l'instrumentation via les fonctionnalités de WebPack n'est plus possible (changement du builder Angular). Donc la couverture de code n'est plus possible pour le moment.
  * lignes de code (CLOC)
    * remettre en place les scripts _cloc*_ dans le _package.json_
    * exécuter les deux commandes _cloc*_ et en vérifier la cohérence manuellement
  * remettre _Maven_ en place
    * à modifier :
	  * récupérer le _pom.xml_ et le répertoire _assembly_
    * pour tester :
	  * exécuter la commande ```mvn clean install```
	  * exécuter la commande ```mvn clean install -P qualimetrie```

  * tester le build Maven nominal
	/!\ retirer le fichier de conf et le bouchonAPI du ZIP généré par Maven
  * tester le build Maven nominal avec le profile _qualimetrie_



Pour vérifier que cela fonctionne, exécuter les commandes :
* de build de la démarche _bibliotheque_ avec la commande ```npm run bibliotheque-build-prod```
* d'analyse de la démarche _bibliotheque_ avec la commande ```npm run bibliotheque-analyseBundle```
* de génération de la documentation de la démarche _bibliotheque_ avec la commande ```npm run bibliotheque-compodoc```
* de démarrage de la démarche _bibliotheque_ avec la commande ```npm run bibliotheque-start```
* de démarrage des tests E2E de la démarche _bibliotheque_ avec la commande ```npm run bibliotheque-e2e```


### 3.34.2.3 - Montée de version Angular
_ Cette procédure est à mettre à jour depuis l'abandon de YARN_
La _DINUM_ publie régulièrement des versions de la librairie _System Design_ de l'état.
Une montée de version est à réaliser de la manière suivante :
* dans une commande DOS et pas Git4windows, démarrer l'outil d'_upgrade_ de _Yarn_ avec la commande (s'il n'est pas installé, ```yarn plugin import interactive-tools```)
```yarn upgrade-interactive```
* attendre que toutes les libs soient chargées
* sélectionner (carré vert) la dernière version de la librairie DSFR
* taper ENTRER pour valider les sélections et lancer l'installation
* vérifier que le projet _front_ fonctionne en 
  * exécutant un build complet : ```npm run all-build-prod```
  * exécutant les tests ```npm run e2e``` vs ```npm run xx-start``` avec xx chacune des démarches
  * exécutant les tests avec couverture de code ```npm run e2e``` vs ```npm run xx-startcoverage``` avec xx chacune des démarches

### 3.34.2.4 - Montée de version DSFR
_ Cette procédure est à mettre à jour depuis l'abandon de YARN_

La mise à jour de la dépendance DSFR est régulière.
Elle est à réaliser de la manière suivante :
* dans une commande DOS et pas Git4windows, démarrer l'outil d'_upgrade_ de _Yarn_ avec la commande (s'il n'est pas installé, ```yarn plugin import interactive-tools```)
```yarn upgrade-interactive```
* attendre que toutes les libs soient chargées
* sélectionner (carré vert) la version à installer dans la colonne _Range_ pour la librairie DSFR
* taper ENTRER pour valider les sélections et lancer l'installation
* vérifier que le projet _front_ fonctionne en 
  * exécutant un build complet : ```npm run all-build-prod```
  * exécutant les tests ```npm run e2e``` vs ```npm run xx-start``` avec xx chacune des démarches
  * exécutant les tests avec couverture de code ```npm run e2e``` vs ```npm run xx-startcoverage``` avec xx chacune des démarches
* pour chaque composant HTML de la DSFR utilisé dans l'application, vérifier la structure HTML de chacun (La structure évolue. La documentation aussi. Mais aucun guide de migration n'existe) :

|           Composant(s) PSL            |                                                           Composant DSFR                                                                |                        Adaptation(s)                         |
| ------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------ |
| contenu/contenuautocompletion         | [composants/champ-de-saisie](https://www.systeme-de-design.gouv.fr/elements-d-interface/composants/champ-de-saisie/)                    | valide vis-à-vis du chapitre "Autres types de champs"        |
| contenu/contenucase                   | [composants/case-a-cocher](https://www.systeme-de-design.gouv.fr/elements-d-interface/composants/case-a-cocher)                         | valide vis-à-vis du chapitre "Pour les développeurs"         |
| contenu/contenudate                   | [composants/champ-de-saisie](https://www.systeme-de-design.gouv.fr/elements-d-interface/composants/champ-de-saisie/)                    | valide vis-à-vis du chapitre "Autres types de champs"        |
| contenu/contenudocuments              | [composants/telechargement-de-fichier](https://www.systeme-de-design.gouv.fr/elements-d-interface/composants/telechargement-de-fichier) | valide vis-à-vis du chapitre "Carte"                         |
| contenu/contenufindemarchenonconnecte | [composants/groupe-de-boutons](https://www.systeme-de-design.gouv.fr/elements-d-interface/composants/groupe-de-boutons/)                | valide vis-à-vis du chapitre "Tailles"                       |
| contenu/contenulistefinie             | [composants/liste-deroulante](https://www.systeme-de-design.gouv.fr/elements-d-interface/composants/liste-deroulante)                   | valide vis-à-vis du chapitre "État de succès"                |
| contenu/contenuparagraphe             | [composants/mise-en-avant](https://www.systeme-de-design.gouv.fr/elements-d-interface/composants/mise-en-avant)                         | valide vis-à-vis du chapitre "Structure" mais le composant _paragraphe_ ne gère pas de titre ou de bouton disponibles les callout. Si cela est, un jour, nécessaire, il faudra créer un composant dédié différent de _paragraphe_ |
| contenu/contenuparagraphe             | [composants/mise-en-exergue](https://www.systeme-de-design.gouv.fr/elements-d-interface/composants/mise-en-exergue)                     | valide vis-à-vis du  chapitre "Structure"                    |
| contenu/contenuradio                  | [composants/bouton-radio/](https://www.systeme-de-design.gouv.fr/elements-d-interface/composants/bouton-radio/)                         | valide vis-à-vis des chapitre "Liste horizontale" (pour la structure) et "Pour les développeurs" (pour les styles _valid_ et _error_) |
| contenu/contenusaisie                 | [composants/champ-de-saisie](https://www.systeme-de-design.gouv.fr/elements-d-interface/composants/champ-de-saisie)                     | valide vis-à-vis du chapitre "États erreur et succès" sauf une modification assumée : Dans la documentation, les messages de validation (_valid_ ou _error_) sont affichés, dans tous les composants, dans une _DIV_ contenant des _P_ sauf le composant de saisie. Pour ne pas dupliquer/multiplier les composants, la même structure est utilisée pour le composant de saisie malgré ce que dit la documentation. La seule concession est l'usage d'un _P_ pour invoquer le composant _data-fmk-messagesvalidation_. |
| contenu/contenusaisielongue           | [composants/champ-de-saisie](https://www.systeme-de-design.gouv.fr/elements-d-interface/composants/champ-de-saisie)                     | valide vis-à-vis du chapitre "Zone de texte - textarea" sauf une modification assumée : Dans la documentation, les messages de validation (_valid_ ou _error_) sont affichés, dans tous les composants, dans une _DIV_ contenant des _P_ sauf le composant de saisie. Pour ne pas dupliquer/multiplier les composants, la même structure est utilisée pour le composant de saisie malgré ce que dit la documentation. La seule concession est l'usage d'un _P_ pour invoquer le composant _data-fmk-messagesvalidation_. |
| contenu/contenuuploaddocument         | [composants/ajout-de-fichier](https://www.systeme-de-design.gouv.fr/elements-d-interface/composants/ajout-de-fichier)                   | invalide car le composant PSL est plus riche que celui de la DSFR. Il ne supporte pas le drag&drop. Donc la balise _INPUT_ est masquée et s'affiche, à la place, une zone de drag&drop. De plus, la structure du _label_ est enrichie avec un second _fr-hint-text_ pour différencier l'aide à la saisie des contraintes de document (type et taille).  |
| contenu/messagesvalidation            | -                                                                                                                                       | valide vis-à-vis du composant DSFR radio et liste déroulante |
| conteneurPages/fildariane             | [composants/indicateur-d-etapes](https://www.systeme-de-design.gouv.fr/elements-d-interface/composants/indicateur-d-etapes)             | valide                                                       |
| modale/connexionbrouillon             | [modeles/page-de-connexion](https://www.systeme-de-design.gouv.fr/elements-d-interface/modeles/page-de-connexion)                       | valide en retirant beaucoup d'éléments du premier chapitre   |
| morceaudepage/entete                  | [composants/en-tete](https://www.systeme-de-design.gouv.fr/elements-d-interface/composants/en-tete)                                     | valide vis-à-vis des chapitres combinés de la documentation  |
| morceaudepage/entete                  | [composant/selecteur-de-langue](https://www.systeme-de-design.gouv.fr/elements-d-interface/composants/selecteur-de-langue)              | valide                                                       |
| morceaudepage/entete/messageglobal    | [composants/alerte](https://www.systeme-de-design.gouv.fr/elements-d-interface/composants/alerte)                                       | valide                                                       |
| morceaudepage/pieddepage              | [composants/pied-de-page](https://www.systeme-de-design.gouv.fr/elements-d-interface/composants/pied-de-page)                           | invalide car construit depuis le pied de page de la vrai PSL |

### 3.34.2.5 - Montée de version des autres dépendances Node
_ Cette procédure est à mettre à jour depuis l'abandon de YARN_

La mise à jour des dépendances autres que celles d'Angular et DSFR est régulière.
Elle est à réaliser de la manière suivante :
* dans une commande DOS et pas Git4windows, démarrer l'outil d'_upgrade_ de _Yarn_ avec la commande (s'il n'est pas installé, ```yarn plugin import interactive-tools```)
```yarn upgrade-interactive```
* attendre que toutes les libs soient chargées
* sélectionner (carré vert) les versions à installer dans la colonne _Range_ sauf la librairie DSFR
* taper ENTRER pour valider les sélections et lancer l'installation
* vérifier que le projet _front_ fonctionne en 
  * exécutant un build complet : ```npm run all-build-prod```
  * exécutant les tests ```npm run e2e``` vs ```npm run xx-start``` avec xx chacune des démarches
  * exécutant les tests avec couverture de code ```npm run e2e``` vs ```npm run xx-startcoverage``` avec xx chacune des démarches

___
## 3.34.3 - Mise à jour des outils

### 3.34.3.1 - VSCode
La mise à jour de VSCode est opportuniste car elle se fait dès que l'IDE annonce la sortie d'une nouvelle version.
Elle est à réaliser de la manière suivante :
* télécharger l'archive contenant l'IDE depuis Internet (site internet ou depuis l'IDE)
* dézipper l'archive dans le répertoire des outils en faisant attention à conserver le numéro de version de l'IDE dans le nom du répertoire
* modifier le raccourci vers l'IDE en y changeant le numéro de version
* mettre à jour la page contenant la backlog et programmer la prochaine mise à jour pour le prochain trimestre
* modifier la version à installer dans les [chapitre 3.2](/documentation/3developpement/3.2installationdeposte/)

___
### 3.34.3.2 - Eclipse
La mise à jour d'Eclipse est régulière car une version sort tous les trimestres.
Elle est à réaliser de la manière suivante :
* télécharger l'archive contenant la version _Eclipse IDE for Java Developers_ de l'IDE depuis le site [Internet officiel](https://www.eclipse.org/downloads/packages/)
* dézipper l'archive dans le répertoire des outils en faisant attention à conserver le numéro de version de l'IDE dans le nom du répertoire
* modifier le raccourci vers l'IDE en y changeant le numéro de version
* accepter, au démarrage, qu'Eclipse transforme le workspace pour le rendre compatible avec la nouvelle version de l'IDE (au besoin, recréer un workspace avec la procédure ci-dessous)
* après le démarrage, il est nécessaire d'installer le plugin SonarLint
* mettre à jour la page contenant la backlog et programmer la prochaine mise à jour pour le prochain trimestre
* modifier la version à installer dans les [chapitre 3.2](/documentation/3developpement/3.2installationdeposte/)

Si, à la montée de version Eclipse, le workspace n'est plus utilisable (par exemple, raccourci cassé à la montée de version 2022-12), il faut :
* arrêter Eclipse
* renommer le répertoire du workspace existant en le suffixant de _-old_
* démarrer Eclipse (il va recréer un répertoire puisqu'il est en paramètre de l'exécutable dans le raccourci - cf. procédure d'installation du poste)
* configurer :
  * General > Workspace : définir l'encoding UTF8 et le délimiteur Unix pour tout nouveau fichier
  * Maven : définir l'installation externe à Eclipse
  * Maven : définir le chemin du fichier de configuration et cliquer sur le bouton _Update settings_
  * Java > Installed JRE : ajouter le dernier JDK en date, en faire la version par défaut et supprimer tout autre installation Java
  * Java > Code style > Formatter : importer le fichier de configuration présent [dans la documentation](/documentation/installationdeposte/pourRefaireLeMetadata/formatteurCodeEclipse.xml)
  * Java > Editor > Save actions : configurer chaque formulaire jusqu'à obtenir [cette configuration](/documentation/installationdeposte/pourRefaireLeMetadata/saveActions.png)
  * General > Keys : créer vos raccourcis si vous en paramétrer habituellement (_²²_ pour _rerun Junit test_ par exemple)
  * Run/Debug > console : désactiver la limite de sortie de la console
  * Run/Debug > Launching : cocher _always_ pour la sauvegarde des fichiers en cours d'édition (première question du formulaire en version 2023-06)
  * Run/Debug > Perspective : cocher _always_ pour l'ouverture de la prespective au lancement (première question du formulaire en version 2023-06)
  * Version control > Git > Project : décocher toutes les cases
  * SonarLint > File exclusions : ajouter une exclusion _*.rdb_
  * réorganiser les perspectives _Java_ et _Debug_ pour faire apparaitre les vues _progress_
* au besoin, comparer les fichiers présents dans _.metadata\.plugins\org.eclipse.core.runtime\.settings\_
* arrêter Eclipse
* créer une archive ZIP du répertoire _.metadata_ et la conserver dans la documentation
* supprimer le répertoire du workspace précédent suffixé par _-old_
* importer les projets du socle qui ne sont pas de type _POM_ (ceux qui n'ont pas d'enfant)

___
### 3.34.3.3 - Java
La mise à jour de Java est régulière car une version sort régulièrement.
Elle est à réaliser de la manière suivante :
* télécharger l'archive contenant le nouveau JDK depuis le site [Internet officiel](https://jdk.java.net/)
* dézipper l'archive dans le répertoire des outils en faisant attention à conserver le numéro de version du JDK dans le nom du répertoire
* ouvrir les paramètres système pour modifier les variables d'environnement (rechercher _modifier les variables d'environnement système_ dans le _menu démarrer_)
* modifier la variable d'environnement _JAVA_HOME_
* vérifier que _JAVA_HOME_ fait partie de _path_
* fermer les fenêtres de commandes déjà ouvertes et ouvrir une nouvelle fenêtre de commandes
* vérifier que la version de Java est bien prise en compte avec la commande ```java -version```
* vérifier que le projet _socle_ fonctionne en exécutant un build nominal ```mvn clean install```
* ajouter le certificat racine de l'entreprise (si nécessaire) dans le nouveau JDK avec les informations du [chapitre 3.2.7](/documentation/3developpement/3.2installationdeposte/#327---ré-activer-la-vérification-ssl)
* ajouter le certificat TLS newPSL dans le nouveau JDK avec les informations du [chapitre 3.2.8.1](/documentation/3developpement/3.2installationdeposte/#3281---créer-le-certificat-racine-et-le-faire-accepter-par-windows-et-java) (rechercher _Importer le certificat racine_)
* dans le raccourci démarrant Eclipse, changer le chemin du JDK
* modifier la version du JDK dans la description du raccourci présente au [chapitre 3.2.5.2](/documentation/3developpement/3.2installationdeposte/#3252---ide---eclipse)
* dans le workspace d'Eclipse, ajouter le nouveau JDK et retirer l'ancien  (_Window_ > _Preferences_ > _Java_ > _Installed JRE_)
* revoir l'intéret 
  * de l'argument _-XX:+EnableDynamicAgentLoading _ dans _2-code/socle/pom.xml_ et dans tous les _.launch_ qui permet de désactiver les warning s'affichant durant les tests automatisés (cf. https://github.com/mockito/mockito/issues/3037 et https://openjdk.org/jeps/451)
  * de l'argument _--enable-preview_ non activable actuellement car Eclipse-202309 ne le supporte pas pour le JDK-21.
* mettre à jour la page contenant la backlog et programmer la prochaine mise à jour pour le prochain trimestre
* modifier la version à installer dans les [chapitre 3.2](/documentation/3developpement/3.2installationdeposte/)

___
### 3.34.3.4 - Node
_ Cette procédure est à mettre à jour depuis l'abandon de YARN _

La mise à jour de Node/npm est régulière car une version sort régulièrement.
Elle est à réaliser de la manière suivante :
* télécharger l'archive contenant la nouvelle version de Node depuis le site [Internet officiel](https://nodejs.org/en/download/) en version _Windows Binary (.zip)_ et _64 bits_
* dézipper l'archive dans le répertoire des outils en faisant attention à conserver le numéro de version de Node dans le nom du répertoire
* ouvrir les paramètres système pour modifier les variables d'environnement (rechercher _modifier les variables d'environnement système_ dans le _menu démarrer_)
* modifier la variable d'environnement _NODE_HOME_
* vérifier que _NODE_HOME_ fait partie de _path_
* redémarrer la console GIT et VSCode pour prendre en compte la modification de la variable d'environnement
* si un outil de sécurité modifie l'autorité de certification sur l'URL _https://registry.npmjs.org/_, il faut ([source](https://stackoverflow.com/questions/70580425/error-when-performing-the-request-while-installing-yarn)) :
  * accéder au site _https://registry.npmjs.org/_ avec le navigateur Chrome
  * afficher les détails du certificat
  * télécharger le certificat racine de l'outil dans un fichier au format CRT
  * exécuter la commande suivante :
```
set NODE_EXTRA_CA_CERTS=%JAVA_HOME%\lib\security\xxx.crt
```
* vérifier les versions installées avec les commandes ```node -v``` et ```npm -v```
* dans une commande _DOS_ (et pas _git4windows_), utiliser la commande ```yarn upgrade-interactive``` pour mettre à jour la dépendance _@types/node_ à la version de l'outil _Node_ installée
* mettre à jour le fichier _2-code/front/pom.xml_ pour mettre à jour la version
  * de _Node_ avec la version affichée dans la console,
  * de _Npm_ avec la version affichée dans la console,
* vérifier que le projet _front_ fonctionne en exécutant
  * un ```npm install```
  * un simple démarrage avec ```npm run etatcivil-start```
  * un build complet via _Node_ avec la commande ```npm run all-build-prod```
  * un build complet via _Maven_ avec la commande ```mvn clean install -P qualimetrie```
* mettre à jour la page contenant la backlog et programmer la prochaine mise à jour pour le prochain trimestre
* modifier la version à installer dans les [chapitre 3.2](/documentation/3developpement/3.2installationdeposte/#324---node--co)

___
### 3.34.3.5 - Maven
La mise à jour de Maven est régulière car une version sort régulièrement.
Elle est à réaliser de la manière suivante :
* télécharger l'archive contenant la nouvelle version de maven depuis le site [Internet officiel](https://maven.apache.org/download.cgi)
* dézipper l'archive dans le répertoire des outils en faisant attention à conserver le numéro de version dans le nom du répertoire
* ouvrir les paramètres système pour modifier les variables d'environnement (rechercher _modifier les variables d'environnement système_ dans le _menu démarrer_)
* modifier la variable d'environnement _MAVEN_HOME_
* vérifier que _MAVEN_HOME_ fait partie de _path_
* remplacer le fichier _MAVEN_HOME/conf/settings.xml_ du nouveau _Maven_ par celui de l'ancien
* fermer toutes les fenêtres de commande et en ouvrir une nouvelle
* vérifier la version de _Maven_ en exécutant la commande ```mvn -v```
* vérifier que le projet _socle_ fonctionne en exécutant un build nominal ```mvn clean install```
* dans Eclipse, la version embarquée de Maven est utilisée. Mais il faut pointer sur le même fichier de configuration (_Window_ > _Preferences_ > _Maven_ > _User Settings_)
* une fois le _workspace_ du projet modifié, il est certainement nécessaire de modifier le _workspace_ des autres projets présents sur le poste de développement
* mettre à jour la page contenant la backlog et programmer la prochaine mise à jour pour le prochain trimestre
* modifier la version à installer dans les [chapitre 3.2](/documentation/3developpement/3.2installationdeposte/)

___
## 3.34.4 - Documentation du Socle

Depuis l'usage de _DependencyTrack_, les rapports HTML _DependencyCheck_ n'ont plus de sens. La veille sécuritaire (recherche et analyses) se fait donc via l'outil _DependencyTrack_ (cf. [§3.34.5](/documentation/3developpement/3.34proceduressecurite/#3345---suivi-de-sécurité-avec-dependencytrack)).

La documentation générée pour le _Socle_ a néanmoins encore du sens.

### 3.34.4.1 - Rapports du Socle
La génération des rapports a particulièrement de sens à être exécutée après les montées de version des dépendances du _Socle_.

Puis il suffit d'utiliser la commande ```mvn clean install -P qualimetrie```. Cette commande exécute l'ensemble complet de toutes les actions possibles :
* exécution des tests automatisés avec couverture
* packaging
  * des livrables
  * des sources (en [jar-source](https://maven.apache.org/plugins/maven-source-plugin/usage.html))
  * des javadoc (en jar-javadoc](https://maven.apache.org/plugins/maven-javadoc-plugin/jar-mojo.html))
* génération de rapport
  * de couverture de code
* copie de certains éléments dans la partie documentaire du dépôt : [dans la page des liens documentaires](/documentation/2conceptiondetaillee/2.9liensdocumentaires/)

Une fois les rapports générés, ces derniers sont consultables immédiatement [dans la page des liens documentaires](/documentation/2conceptiondetaillee/2.9liensdocumentaires/).

___
### 3.34.4.2 - Tests de sécurité avec OWASP ZAP
Pour installer l'outil :
* télécharger, depuis le [site officiel](https://www.zaproxy.org/download/), l'archive ZAP_2.11.1_Crossplatform.zip
* ouvrir l'archive téléchargée avec 7zip pour modifier le fichier _lib/log4j-core-2.15.0.jar_ en _log4j-core-2.15.0.abc_ (car certains outils de protection refusent l'écriture sur disque de ce fichier)
* extraire le contenu de l'archive dans le répertoire _outils_
* ouvrir l'archive _xxxxxx/ZAP_2.xx.x/zap-2.xx.x.jar_ avec 7zip et modifier, dans le fichier _META_INF/MANIFEST.MF_, le nom du jar de _log4j_

Pour utiliser OWASP ZAP :
* démarrer l'outil via le script _zap.bat_
* sélectionner la session présente dans le projet documentaire (nommée _sessionOwaspZap décrite plus bas)
* dans la liste déroulante en haut à gauche, sélectionner la valeur _mode standard_
* dans la fenêtre principale, cliquer sur _Automated scan_
* saisir l'URL _http://dev-psl.guillaumetalbot.com/mademarche/bibliotheque/_ avec les spider _ajax_ (avec Chrome headless) et traditionnel
* lancer l'audit (plusieurs dizaines de minutes)
* analyser les résultats

Pour information, la session créée a été paramétrée avec :
* l'exclusion des sites _https://.*_ dans _exclure du proxy_, _exclure du balayage_ et _exclure du robot d'indexation_
* l'inclusion, dans le contexte, des sites _http://dev-psl.guillaumetalbot.com/mademarche_, _http://dev-psl.guillaumetalbot.com/mademarche.*_, _http://localhost:8080_ et _http://localhost:8080.*_
* l'import du swagger des APIs

___
## 3.34.5 - Suivi de sécurité avec DependencyTrack

### 3.34.5.1 - Installation/réinstallation et préparation d'une instance locale de DependencyTrack

_procédure issue de la [documentation officielle](https://docs.dependencytrack.org/getting-started/deploy-exewar/)_

**!!! ATTENTION A PREVOIR 2Go DE DISQUE ET, AU MINIMUM, 45 MINUTES DE TEMPS D'EXECUTION DE L'OUTIL POUR SON INITIALISATION (téléchargement de 1,2Go de JSON du NIST compressé en 70Mo de GZ) !!!**

Pour installer DependencyTrack, exécuter les actions suivantes :
* Sortir de tout réseau nécessitant un proxy pour accéder à Internet
* Télécharger, depuis le [site GitHub](https://github.com/DependencyTrack/dependency-track/releases) la dernière release nommée _dependency-track-bundled.jar_.
* Placer le livrable dans le répertoire _2-code\securite\dependencyTrack_ (écraser l'existant s'il est présent)
* Ouvrir une ligne de commande dans ce répertoire
* Démarrer l'application avec le script _2-code/socle/securite/dependencyTrack/dependencyTrack.sh_ ou la commande ```java -Xmx4G -jar dependency-track-bundled.jar -port 9999``` (testé en 04/2024 avec Java-21)
* Ignorer les avertissements concernant le fichier _id.system_
* Ne rien arrêter tant que les logs indiquent des téléchargements et du _parsing_ de fichier

Pour simplement mettre à jour _DependencyTrack_, exécuter les étapes suivantes :
* Vérifier son bon fonctionnement en cliquant sur ce lien menant à [l'application démarrée localement](http://localhost:9999/) 
* Se connecter avec le compte _admin_ et le nouveau mot de passe défini (à sauvegarder dans un _KeePass_)

Pour initialiser _DependencyTrack_ la première fois, exécuter les étapes suivantes :
* Vérifier son bon fonctionnement en cliquant sur ce lien menant à [l'application démarrée localement](http://localhost:9999/) 
* Se connecter avec le compte _admin_ et le mot de passe _admin_
* Changer le mot de passe comme l'impose l'application
* Se reconnecter avec le compte _admin_ et le nouveau mot de passe défini (à sauvegarder dans un _KeePass_)
* Accéder à la page _administration_ > _Access management_ > _Teams_
* Créer une équipe nommée _AnalyseLocale_
* Cliquer sur la ligne de l'équipe créée
* Mettre la clef d'API (dans la suite de la procédure, elle se nomme _XXCLEFAPIXX_)
* Ajouter les droits _BOM_UPLOAD_ et _VIEW_PORTFOLIO_
* Accéder à la page _Policy Management_
* Créer les _policy_ suivantes 
  * 1 (ne semble pas fonctionnel au 11/2023) :
    * Name : _Composant avec version majeure de retard_
    * Operator : _any_
    * Violation state : _Warn_
    * Conditions : _Version Distance > 0 1 0 0_
  * 2 :
    * Name : _Composant de plus d'un an_
    * Operator : _any_
    * Violation state : _Inform_
    * Conditions : _Age > P1Y_
  * 3 (ne semble pas fonctionnel au 11/2023) :
    * Name : _Composant pas à la dernière version_
    * Operator : _any_
    * Violation state : _Inform_
    * Conditions : _Version Distance > 0 0 0 1_
  * 4 :
    * Name : _Licence CopyLeft Interdite_
    * Operator : _any_
    * Violation state : _Fail_
    * Conditions : _Licence group is copylef_
  * 5 :
    * Name : _Licence NonCommeciale Interdite_
    * Operator : _any_
    * Violation state : _Fail_
    * Conditions : _Licence group is Nom-Commercial_

___
### 3.34.5.2 - Audit des projets SOCLE et FRONT
Réaliser une analyse du _socle_ en exécutant les étapes suivantes :
* Dans le répertoire _2-code/socle_, exécuter la commande ```mvn org.cyclonedx:cyclonedx-maven-plugin:makeAggregateBom```
* Vérifier que _DependencyTrack_ s'exécute
* Exécuter la commande ```curl -X "POST" http://localhost:9999/api/v1/bom -H 'Content-Type: multipart/form-data' -H "X-Api-Key: XXCLEFAPIXX" -F "autoCreate=xxAUTOxx" -F "projectName=newPslSocle" -F "projectVersion=xxVERSIONxx" -F bom=@target/bom.xml```
  * avec _xxVERSIONxx_ une date au format _yyyyMM_ (par exemple 202404 pour avril 2024)
  * avec _XXCLEFAPIXX_ la clef créée plus tôt (ou à récupérer dans _DependencyTrack_ > _Access Management_ > _Teams_ > _AnalyseLocale_)
* Vérifier que la réponse soit au format ```{"token":"eef176b8-feea-4786-97e4-817e97763a2a"}```
* Dans l'IHM de _DependencyTrack_, vérifier la présence du projet dans la page _Projects_ 

Réaliser une  analyse du _front_ en exécutant les commandes suivantes !!!!!!!NE FONCTIONNE PAS POUR LE MOMENT (04/2024) !!!!!!!!!!! :
* Dans le répertoire _2-code/front_, depuis une ligne de commande _DOS_, exécuter les commandes suivantes :
  * Pour installer globalement l'outil d'analyse ```npm install --global @cyclonedx/cyclonedx-npm```
  * Pour créer un _package-lock.json_ pour les besoins de l'analyse ```npm install --package-lock-only --force```
  * Pour générer le _BOM_ du _front_ ```cyclonedx-npm --output-format XML --output-file bom.xml```
  * Supprimer le répertoire _node_modules_
  * Supprimer le fichier _package-lock.json_
* Créer le projet _newPslFront_ avec la commande suivante (en remplaçant la clef) ```curl -X "POST" http://localhost:8080/api/v1/bom -H 'Content-Type: multipart/form-data' -H "X-Api-Key: XXCLEFAPIXX" -F "autoCreate=true" -F "projectName=newPslFront" -F "projectVersion=1.0.0" -F bom=@bom.xml```

___
### 3.34.5.3 - Raffrachir un audit
Pour relancer (après modification d'un paramètre ou évolution du BOM) une analyse, exécuter la commande en y remplaçant la clef d'API, le nom du projet et le chemin vers le bom.xml :
```curl -X "POST" http://localhost:9999/api/v1/bom -H 'Content-Type: multipart/form-data' -H "X-Api-Key: XXCLEFAPIXX" -F "projectName=newPslXXXX" -F "projectVersion=1.0.0" -F bom=@target/bom.xml```

___
### 3.34.5.4 - Analyse
Pour information, le code Java du Socle se base sur de nombreuses dépendances toute sous licence. Certaines de ces licences autorisent un usage en milieu professionnel mais d'autres non : elles imposent que le code dépendant soit tout aussi OpenSource que la dépendance elle-même. Ceux sont les licences _Copyleft_.

Etudier une analyse _DependencyTrack_ avec les consignes suivantes :
* Dans l'IHM de _DependencyTrack_, accéder à la page _Projects_ > _newPslSocle_
* Vérifier la présence de licence interdites (commerciale ou _copyLeft_) dans l'onglet _Policy violations_
  * Vérifier si la version est la plus récente
  * Vérifier si la licence a évolué récemment (à l'échelle du rythme des release de ce composant)
  * Vérifier si la dépendance est directe ou pas. Si elle est indirecte, peut-on s'en passer ?
  * Commenter chaque violation pour un suivi
* Vérifier la présence de vulnérabilité dans l'onglet _Audit Vulnerabilities_
  * Traiter les vulnérabilités par sévérité décroissantes :
    * Si la faille existe et qu'il est possible de la combler en changeant le code appelant ou en modifiant la dépendance directe (et uniquement la dépendance directe !), la correction est à faire.
    * Si la faille existe et qu'il n'est pas possible de la combler, autant savoir qu'elle existe et surveiller de près la dépendance fautive pour réaliser une mise à jour rapidement.
    * Si la faille n'existe pas, il est possible de l'ignorer dans l'outil (sans oublier de mettre un commentaire) 
  * Systématiquement, commenter chaque vulnérabilité pour un suivi

Un bon référentiel des licences est disponible [sur Wikipedia](https://en.wikipedia.org/wiki/Comparison_of_free_and_open-source_software_licenses)
